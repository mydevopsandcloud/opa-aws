terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region                      = "us-west-2"
  skip_credentials_validation = true
  skip_requesting_account_id  = true
  skip_metadata_api_check     = true
  access_key                  = "mock_access_key"
  secret_key                  = "mock_secret_key"
}

# Resource under test
resource "aws_ecrpublic_repository" "fail_example" {
  repository_name = "fail-example"
}

# Attach a repository policy with restricted action under Allow
resource "aws_ecrpublic_repository_policy" "fail_example" {
  repository_name = aws_ecrpublic_repository.fail_example.repository_name
  policy          = data.aws_iam_policy_document.fail_policy.json
}

data "aws_iam_policy_document" "fail_policy" {
  statement {
    sid    = "AllowPutImage"
    effect = "Allow"

    principals {
      type        = "AWS"
      identifiers = ["*"]
    }

    actions = [
      "ecr-public:PutImage"
    ]
  }
}
