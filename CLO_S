package wiz

import data.generic.common as common_lib
import data.generic.terraform as terralib

# Policy to check if stateless rules have empty match_attributes
WizPolicy[result] {
    resource := input.document[i].resource.aws_networkfirewall_rule_group[name]
    
    # Navigate to stateless rules
    rule_group := resource.rule_group[_]
    rules_source := rule_group.rules_source[_]
    stateless_rules_and_custom_actions := rules_source.stateless_rules_and_custom_actions[_]
    stateless_rule := stateless_rules_and_custom_actions.stateless_rule[_]
    rule_definition := stateless_rule.rule_definition[_]
    
    # Check if match_attributes exists but is empty (no child attributes)
    match_attributes := rule_definition.match_attributes[_]
    is_empty_match_attributes(match_attributes)
    
    result := {
        "documentId": input.document[i].id,
        "resourceName": terralib.get_resource_name(resource, name),
        "resourceType": "aws_networkfirewall_rule_group",
        "searchKey": sprintf("aws_networkfirewall_rule_group[%s].rule_group.rules_source.stateless_rules_and_custom_actions.stateless_rule.rule_definition.match_attributes", [name]),
        "issueType": "IncorrectValue",
        "keyExpectedValue": sprintf("'aws_networkfirewall_rule_group[%s]' stateless rules should have non-empty match_attributes", [name]),
        "keyActualValue": sprintf("'aws_networkfirewall_rule_group[%s]' stateless rule has empty match_attributes", [name]),
        "resourceTags": object.get(resource, "tags", {}),
    }
}

# Helper function to check if match_attributes is empty
is_empty_match_attributes(match_attributes) {
    # Check if match_attributes has no meaningful content
    # An empty match_attributes block would have no keys or only empty nested objects
    count(object.get(match_attributes, "source", [])) == 0
    count(object.get(match_attributes, "destination", [])) == 0
    count(object.get(match_attributes, "source_port", [])) == 0
    count(object.get(match_attributes, "destination_port", [])) == 0
    count(object.get(match_attributes, "protocols", [])) == 0
    count(object.get(match_attributes, "tcp_flag", [])) == 0
}

# Alternative approach - check if match_attributes block exists but has no child attributes
is_empty_match_attributes(match_attributes) {
    # If match_attributes is an empty object
    count(match_attributes) == 0
}
