package wiz

import data.generic.terraform as terralib

WizPolicy[result] {
    resourceType := "aws_networkfirewall_firewall_policy"
    resource := input.document[i].resource[resourceType][name]

    firewall_policy := terralib.getValueFromArrayOfObject(resource.firewall_policy)

    # Extract stateless rule group ARNs from firewall policy
    stateless_refs := [ ref.rule_group_arn |
        stateless_ref := object.get(firewall_policy, "stateless_rule_group_reference", []),
        ref := stateless_ref[_]
    ]

    # If no stateless rule groups at all â†’ Fail
    count(stateless_refs) == 0

    result := {
        "documentId": input.document[i].id,
        "resourceName": terralib.get_resource_name(resource, name),
        "resourceType": resourceType,
        "searchKey": sprintf("%s[%s].firewall_policy.stateless_rule_group_reference", [resourceType, name]),
        "issueType": "MissingAssociation",
        "keyExpectedValue": "At least one stateless rule group should be associated",
        "keyActualValue": "No stateless rule group is associated",
        "resourceTags": object.get(resource, "tags", {}),
    }
}
